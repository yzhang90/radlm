<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>RADL</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
<meta name="title" content="RADL"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2015-03-28T13:10-0700"/>
<meta name="author" content="Leonard Gerard"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">RADL</h1>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Files constraints</a></li>
<li><a href="#sec-2">2 Meta syntax rules</a>
<ul>
<li><a href="#sec-2-1">2.1 Grammar</a></li>
<li><a href="#sec-2-2">2.2 Grammar terminals</a></li>
<li><a href="#sec-2-3">2.3 Keywords</a></li>
<li><a href="#sec-2-4">2.4 White spaces</a></li>
<li><a href="#sec-2-5">2.5 Comments</a></li>
</ul>
</li>
<li><a href="#sec-3">3 Identifier scoping rules</a>
<ul>
<li><a href="#sec-3-1">3.1 Scoping regions</a></li>
<li><a href="#sec-3-2">3.2 Local unicity of names</a></li>
<li><a href="#sec-3-3">3.3 Global unicity of qualified names</a></li>
<li><a href="#sec-3-4">3.4 Resolution of identifiers to qualified names</a></li>
<li><a href="#sec-3-5">3.5 Example</a></li>
<li><a href="#sec-3-6">3.6 Shadowing</a>
<ul>
<li><a href="#sec-3-6-1">3.6.1 Example</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-4">4 RADL language</a>
<ul>
<li><a href="#sec-4-1">4.1 Logical level</a>
<ul>
<li><a href="#sec-4-1-1">4.1.1 Nodes</a></li>
<li><a href="#sec-4-1-2">4.1.2 Topics</a></li>
</ul>
</li>
<li><a href="#sec-4-2">4.2 External files and <code>PATH</code></a>
<ul>
<li><a href="#sec-4-2-1">4.2.1 File reference</a></li>
<li><a href="#sec-4-2-2">4.2.2 Working directory of a region, <code>PATH</code> and <code>MODULE_BASE_PATH</code></a></li>
<li><a href="#sec-4-2-3">4.2.3 Example</a></li>
</ul>
</li>
<li><a href="#sec-4-3">4.3 Libraries</a>
<ul>
<li><a href="#sec-4-3-1">4.3.1 Static library</a></li>
<li><a href="#sec-4-3-2">4.3.2 Cmake library</a></li>
</ul>
</li>
<li><a href="#sec-4-4">4.4 Typing</a>
<ul>
<li><a href="#sec-4-4-1">4.4.1 Inference</a></li>
<li><a href="#sec-4-4-2">4.4.2 Checking</a></li>
<li><a href="#sec-4-4-3">4.4.3 Subtyping</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-5">5 User code</a>
<ul>
<li><a href="#sec-5-1">5.1 Compilation</a>
<ul>
<li><a href="#sec-5-1-1">5.1.1 Include directories</a></li>
<li><a href="#sec-5-1-2">5.1.2 Compiler definitions</a></li>
</ul>
</li>
<li><a href="#sec-5-2">5.2 C++ node definition</a>
<ul>
<li><a href="#sec-5-2-1">5.2.1 The input structure <code>radl_in_t</code></a></li>
<li><a href="#sec-5-2-2">5.2.2 The output structure <code>radl_out_t</code></a></li>
<li><a href="#sec-5-2-3">5.2.3 The flag structures <code>radl_in_flags_t</code>, <code>radl_out_flags_t</code></a></li>
</ul>
</li>
<li><a href="#sec-5-3">5.3 C node definition</a></li>
<li><a href="#sec-5-4">5.4 The flags</a>
<ul>
<li><a href="#sec-5-4-1">5.4.1 Computation of the output flags</a></li>
<li><a href="#sec-5-4-2">5.4.2 Computation of the input flag <code>radl_STALE</code></a></li>
<li><a href="#sec-5-4-3">5.4.3 Computation of the input flag <code>radl_TIMEOUT</code></a></li>
<li><a href="#sec-5-4-4">5.4.4 Turning off/on output flags</a></li>
</ul>
</li>
<li><a href="#sec-5-5">5.5 Introspection</a>
<ul>
<li><a href="#sec-5-5-1">5.5.1 Modules root entries</a></li>
<li><a href="#sec-5-5-2">5.5.2 Shortcuts</a></li>
<li><a href="#sec-5-5-3">5.5.3 Field access</a></li>
<li><a href="#sec-5-5-4">5.5.4 The <code>DEFS</code> field</a></li>
<li><a href="#sec-5-5-5">5.5.5 Example</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Files constraints</h2>
<div class="outline-text-2" id="text-1">

<p>A radl description file is a text file, preferably encoded in utf8, with extension ".radl". Such a file is called in short a radl file.
</p></div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Meta syntax rules</h2>
<div class="outline-text-2" id="text-2">

<p>A radl file define a module whose name is the file name. A module is a set of value declarations. A declaration may be an alias, used to declare a value equal to another one but with a new name. The name of a value may be ommited, note that it'll prevent the user to reference this value. The type of a value may also be ommited, note that if the type is ambiguous, the inference will choose one. When defining a class field, one may declare a new value or refer to an other value by its identifier.
</p>
</div>

<div id="outline-container-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Grammar</h3>
<div class="outline-text-3" id="text-2-1">




<pre class="example">module := decl*
decl := alias | NAME? (':' TYPE)? TYPEVALUE | NAME? (':' CLASS)? class_value
alias := NAME = identifier
class_value := '{' field * '}'
field := FIELDNAME value +
value := identifier | decl
identifier := root_name | identifier '.' NAME
root_name := NAME
</pre>

</div>

</div>

<div id="outline-container-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Grammar terminals</h3>
<div class="outline-text-3" id="text-2-2">

<p>The <code>NAME</code> terminal is a spaceless word beginning with a letter which may contain numbers and underscore (the regex <code>[a-zA-Z][a-zA-Z0-9_]*</code>). <code>NAME</code> is also restricted to not be a keyword, or begin with 'radl'.
The other terminals are defined by the <a href="file:///Users/lgerard/W/radler/radler/radlr/language.py">language.py</a> file, with declarations of the form
</p><pre class="example">
'type' TYPE 'REGEX' TYPEVALUE
</pre>

<p>and
</p><pre class="example">
'class' CLASS (FIELDNAME (TYPE|CLASS) ('*'|'+'|'?')?)*
</pre>

</div>

</div>

<div id="outline-container-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> Keywords</h3>
<div class="outline-text-3" id="text-2-3">

<p>Keywords are all <code>TYPE</code>, <code>CLASS</code> and <code>FIELDNAME</code> plus the <code>extra_keywords</code> entry of  <a href="file:///Users/lgerard/W/radler/radler/radlr/language.py">language.py</a>.
</p></div>

</div>

<div id="outline-container-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> White spaces</h3>
<div class="outline-text-3" id="text-2-4">

<p>The syntax requires all terminals to be white space separated. A white space is any number greater than 1 of space, tabulation and end of line.
</p></div>

</div>

<div id="outline-container-2-5" class="outline-3">
<h3 id="sec-2-5"><span class="section-number-3">2.5</span> Comments</h3>
<div class="outline-text-3" id="text-2-5">

<p>After <code>#</code>, any caracter is discarded up to the end of line.
</p></div>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Identifier scoping rules</h2>
<div class="outline-text-2" id="text-3">


</div>

<div id="outline-container-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Scoping regions</h3>
<div class="outline-text-3" id="text-3-1">

<p>A file <code>MODULE</code>.radl defines an implicit scoping region for its content whose name is <code>MODULE</code>. Sub-regions are defined by class values. A class value declaration defines one and only one nested scoping region, syntactically delimited by matching braces, whose name is the declaration <code>NAME</code>.
</p></div>

</div>

<div id="outline-container-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Local unicity of names</h3>
<div class="outline-text-3" id="text-3-2">

<p>Inside each region (not comprising its sub-regions), <code>NAME</code> of each declarations are unique.
Moreover, each module name <code>MODULE</code> is ensured to be unique.
</p></div>

</div>

<div id="outline-container-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Global unicity of qualified names</h3>
<div class="outline-text-3" id="text-3-3">

<p>A qualified name (qname) is an identifier whose <code>root_name</code> is a module name. By unicity of module names and declaration names, a qname defines a value uniquely.
</p></div>

</div>

<div id="outline-container-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> Resolution of identifiers to qualified names</h3>
<div class="outline-text-3" id="text-3-4">

<p>When resolving an identifier, the first step is the resolution of its <code>root_name</code>, which is match with the closest enclosing scoping region or in last resort to another module name. At that point, the <code>root_name</code> is replaced by the qualified name of its matching region and the identifier becomes a qualified name.
</p></div>

</div>

<div id="outline-container-3-5" class="outline-3">
<h3 id="sec-3-5"><span class="section-number-3">3.5</span> Example</h3>
<div class="outline-text-3" id="text-3-5">




<pre class="example">---- file: module1.radl ----
x : int32 0
s : struct { FIELDS x : int32 42 }
----------------------------
</pre>

<p>
This file declares three values whose qnames are <code>module1.x</code>, <code>module1.s</code> and <code>module1.s.x</code>.
</p>


<pre class="example">---- file: module2.radl ----
x : int32 0
s : struct { FIELDS
    x : int32 0
    s2 : struct { FIELDS
        y = x
        y2 = s.x
        y3 = module2.s.x
        z = module2.x
        a = module1.s.x
    }
}
----------------------------
</pre>

<p>
This file declares nine values whose qnames are <code>module2.x</code>, <code>module2.s</code>, <code>module2.s.x</code> , <code>module2.s.s2.y</code> , <code>module2.s.s2.y2</code>, <code>module2.s.s2.y3</code>, <code>module2.s.s2.z</code> and <code>module2.s.s2.a</code>.
When defining the alias <code>y = x</code>, the identifier <code>x</code> is resolved by looking for a name <code>x</code> defined in <code>s2</code> (which doesn't exists) then in the enclosing region <code>s</code> where it is found, thus resolving to <code>module2.s.x</code>. <code>s.x</code> in the declaration of <code>y2</code> is resolved to the same qname by first resolving <code>s</code> to <code>module2.s</code> and replacing it to get <code>module2.s.x</code>. When resolving the identifiers <code>module2.s.x</code>, <code>module2.x</code> and <code>module1.s.x</code>, the <code>root_name</code> is found to be a module name meaning that these identifiers are already qualified names.
</p></div>

</div>

<div id="outline-container-3-6" class="outline-3">
<h3 id="sec-3-6"><span class="section-number-3">3.6</span> Shadowing</h3>
<div class="outline-text-3" id="text-3-6">

<p>While using qualified names for identifiers permit to overcome most possible shadowings, a region will shadow any module with identical name.
</p>
</div>

<div id="outline-container-3-6-1" class="outline-4">
<h4 id="sec-3-6-1"><span class="section-number-4">3.6.1</span> Example</h4>
<div class="outline-text-4" id="text-3-6-1">




<pre class="example">--- file: module3.radl ---

module1 : struct { FIELDS
    y = module1.x
}
--------------------------
</pre>

<p>
In this file, the resolution of <code>module1.x</code> will result in <code>module3.module1.x</code> since the closest enclosing region named <code>module1</code> is the one defined in <code>module3</code>. Thus the definition of the struct named <code>module1</code> shadow the actual module <code>module1</code>.
Note that in this example, since <code>module3.module1.x</code> isn't declared, the compiler will complain about it missing.
</p></div>
</div>
</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> RADL language</h2>
<div class="outline-text-2" id="text-4">


</div>

<div id="outline-container-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Logical level</h3>
<div class="outline-text-3" id="text-4-1">

<p>The two main class used to describe the logical level are node and topic. Their full definition may be found in <a href="file:///Users/lgerard/W/radler/radler/radlr/language.py">language.py</a>. The most important elements are:
</p>


<pre class="example">class node
    PUBLISHES publication *
    SUBSCRIBES subscription *
    CXX cxx_class
    PERIOD duration
    WCET duration
class topic
    FIELDS int8/uint8/int16/uint16/int32/uint32/int64/uint64/
           float32/float64/
           bool/struct/array/duration/time +
</pre>


</div>

<div id="outline-container-4-1-1" class="outline-4">
<h4 id="sec-4-1-1"><span class="section-number-4">4.1.1</span> Nodes</h4>
<div class="outline-text-4" id="text-4-1-1">

<p>When creating a node, radler will construct one instance of the provided C++ class (the <code>CXX</code> field). The step method of this instance will be called at a fixed frequency defined by the node's period (the <code>PERIOD</code> field). This step function needs to be proven to have a worst case execution time inferior to the one described here in the <code>WCET</code> field. At each call, the step function is provided with the messages received from its subscriptions and is required to write the messages it has to publish.
</p></div>

</div>

<div id="outline-container-4-1-2" class="outline-4">
<h4 id="sec-4-1-2"><span class="section-number-4">4.1.2</span> Topics</h4>
<div class="outline-text-4" id="text-4-1-2">

<p>A topic (defined uniquely by its name) is a purely logical way to define point to point communications between one producer and multiple consummers. There needs to be one and only one node publishing to a topic while as many as needed nodes subscribing to it.
</p></div>
</div>

</div>

<div id="outline-container-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> External files and <code>PATH</code></h3>
<div class="outline-text-3" id="text-4-2">


</div>

<div id="outline-container-4-2-1" class="outline-4">
<h4 id="sec-4-2-1"><span class="section-number-4">4.2.1</span> File reference</h4>
<div class="outline-text-4" id="text-4-2-1">

<p>An external file is described by a string representing its path. This path may be absolute (for example "/etc/example.cfg") or relative ("src/defs.h"). Relative paths are resolved relatively to the working directory of the scoping region. Abosulte path files are not recommanded, but may be useful in very specific cases.
</p></div>

</div>

<div id="outline-container-4-2-2" class="outline-4">
<h4 id="sec-4-2-2"><span class="section-number-4">4.2.2</span> Working directory of a region, <code>PATH</code> and <code>MODULE_BASE_PATH</code></h4>
<div class="outline-text-4" id="text-4-2-2">

<p>If a <code>PATH</code> field exists in a region, it is used to set the working directory of this region relatively to the parent region's working directory. The module working directory is the directory of the module file except when it is redefined by the <code>MODULE_BASE_PATH</code> of the <code>module_settings</code> value.
</p></div>

</div>

<div id="outline-container-4-2-3" class="outline-4">
<h4 id="sec-4-2-3"><span class="section-number-4">4.2.3</span> Example</h4>
<div class="outline-text-4" id="text-4-2-3">




<pre class="example">---- file: path1.radl ----
n: node {
    PATH "nodes/example"
    CXX { PATH "src" FILENAME "n.cpp" }
}
----------------------------
</pre>

<p>
Considering that path1.radl is in "/tmp/pathexample", the working directory inside the region <code>n</code> is "/tmp/pathexample/nodes/example" and the file refered by "n.cpp" is "/tmp/pathexample/nodes/example/src/n.cpp"
</p>


<pre class="example">---- file: path2.radl ----
n: node {
    PATH "nodes/example"
    CXX { PATH "src" FILENAME "n.cpp" }
}
settings : module_settings {
  MODULE_BASE_PATH "/usr/pathexample"
}
----------------------------
</pre>

<p>
By adding this <code>module_settings</code> value, "n.cpp" refers to "/usr/pathexample/nodes/example/src/n.cpp".
</p></div>
</div>

</div>

<div id="outline-container-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> Libraries</h3>
<div class="outline-text-3" id="text-4-3">

<p>Any user code needing libraries has to be declared as using a library with the <code>LIB</code> field. This field allows two forms of libraries, <code>cmake_library</code> and <code>static_library</code>.
</p>
</div>

<div id="outline-container-4-3-1" class="outline-4">
<h4 id="sec-4-3-1"><span class="section-number-4">4.3.1</span> Static library</h4>
<div class="outline-text-4" id="text-4-3-1">

<p>Static libraries are of the simplest form, gathering a set of source files in their <code>CXX</code> field while the library header files are found in the <code>HEADER_PATHS</code> paths.
</p></div>

</div>

<div id="outline-container-4-3-2" class="outline-4">
<h4 id="sec-4-3-2"><span class="section-number-4">4.3.2</span> Cmake library</h4>
<div class="outline-text-4" id="text-4-3-2">

<p>The cmake library enables the use of arbitrarily complex libraries since it is a user defined cmake script. The <code>CMAKE_MODULE</code> field provide the cmake module name used to find it in the working directory. <code>COMPONENTS</code> are the required components from this module, used when calling the cmake <code>find_module</code> command. By default, it is expected that the module defines two variables named <code>${CMAKE_MODULE}_LIBRARIES</code> and <code>${CMAKE_MODULE}_INCLUDE_DIRS</code> defining respectively the libraries to be linked against and the inlclude directories. Both vraiable names can be specified if their naming doesn't follow this convention, respectively with the fields <code>CMAKE_VAR_LIBRARIES</code> and <code>CMAKE_VAR_INCLUDE_DIRS</code>.
</p>
</div>
</div>

</div>

<div id="outline-container-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> Typing</h3>
<div class="outline-text-3" id="text-4-4">


</div>

<div id="outline-container-4-4-1" class="outline-4">
<h4 id="sec-4-4-1"><span class="section-number-4">4.4.1</span> Inference</h4>
<div class="outline-text-4" id="text-4-4-1">

<p>When a value is type annoted, it is checked to be of this type.
If no type annotation is provided, the kind of the value is looked among the ones possible in the value declaration context. If there is an ambiguity, is choosen the first fitting in the order of declaration in <a href="file:///Users/lgerard/W/radler/radler/radlr/language.py">language.py</a>.
</p></div>

</div>

<div id="outline-container-4-4-2" class="outline-4">
<h4 id="sec-4-4-2"><span class="section-number-4">4.4.2</span> Checking</h4>
<div class="outline-text-4" id="text-4-4-2">

<p>User values are checked to be correct with their type with the function <code>check_type</code> found in <a href="file:///Users/lgerard/W/radler/radler/radlr/language.py">language.py</a>.
</p></div>

</div>

<div id="outline-container-4-4-3" class="outline-4">
<h4 id="sec-4-4-3"><span class="section-number-4">4.4.3</span> Subtyping</h4>
<div class="outline-text-4" id="text-4-4-3">

<p>Subtyping allows for example to use a 16bits integer (<code>int16</code>) where a 32bits integer is required (<code>int32</code>).
For now, subtyping is only done on <code>sized_types</code> by allowing a type to be used in a bigger version. <code>sized_types</code> and possible sizes are explicited in <a href="file:///Users/lgerard/W/radler/radler/radlr/language.py">language.py</a>. User values are checked to fit the type's size with the function <code>check_type_size</code>.
</p>
</div>
</div>
</div>

</div>

<div id="outline-container-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> User code</h2>
<div class="outline-text-2" id="text-5">


</div>

<div id="outline-container-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> Compilation</h3>
<div class="outline-text-3" id="text-5-1">


</div>

<div id="outline-container-5-1-1" class="outline-4">
<h4 id="sec-5-1-1"><span class="section-number-4">5.1.1</span> Include directories</h4>
<div class="outline-text-4" id="text-5-1-1">

<p>The generated code is setup so that user code is compiled with the necessary include folders, meaning specified libraries header folders and the working directory of the file references.
</p></div>

</div>

<div id="outline-container-5-1-2" class="outline-4">
<h4 id="sec-5-1-2"><span class="section-number-4">5.1.2</span> Compiler definitions</h4>
<div class="outline-text-4" id="text-5-1-2">

<p>The user code is compiled with the following definitions:
</p><ul>
<li><code>IN_RADL_GENERATED_CONTEXT</code> : the basic definition to detect if the code is compiled within RADL compilation chain.

</li>
<li><code>RADL_NODE_NAME</code> : the name of the current radl node.
</li>
<li><code>RADL_NODE_QNAME</code> : which is set to the node qualname (with dot separators, for example "<code>modulename.nodename</code>").

</li>
<li><code>RADL_MODULE_NAME</code> : the name of the current radl module.
</li>
<li><code>RADL_MODULE</code> : a pointer to the current module ast root (may be used like RADL<sub>MODULE</sub>-&gt;{nom d'une variable du module courrant}).

</li>
<li><code>RADL_HEADER</code> : the radl generated header to be included by the user code (defining input and output data types).

</li>
<li><code>RADL_STATE</code> : the radl default name to be used for the C state type (if not specified in the radl file).
</li>
<li><code>RADL_STEP_FUN</code> : the default name to be used for the C step function (if not specified in the radl file).
</li>
<li><code>RADL_INIT_FUN</code> : the default name to be used for the C init function (if not specified in the radl file).
</li>
<li><code>RADL_FINISH_FUN</code> : the default name to be used for the C finish function (if not specified in the radl file).
</li>
</ul>

</div>
</div>

</div>

<div id="outline-container-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> C++ node definition</h3>
<div class="outline-text-3" id="text-5-2">

<p>Every node is a mealy machine. The user provide a class which will be instantiated with the default constructor to generate an instance representing the state of the machine. Then, the <code>step</code> method of this instance will be called to execute one step of the machine. The signature of the <code>step</code> method is required to be:
</p><pre class="example">
void step(const radl_in_t*, const radl_inflags_t*, radl_out_t*, radl_outflags_t*)
</pre>

<p>The four argument types are structures defined in the generated header file.
</p>
</div>

<div id="outline-container-5-2-1" class="outline-4">
<h4 id="sec-5-2-1"><span class="section-number-4">5.2.1</span> The input structure <code>radl_in_t</code></h4>
<div class="outline-text-4" id="text-5-2-1">

<p>This struture has one field per subscription of the node. The field name is the radl name of the subscription. Each field is in turn a structure reflecting the topic of the subscription, whose fields are the name of the radl topic <code>FIELDS</code>.
</p></div>

</div>

<div id="outline-container-5-2-2" class="outline-4">
<h4 id="sec-5-2-2"><span class="section-number-4">5.2.2</span> The output structure <code>radl_out_t</code></h4>
<div class="outline-text-4" id="text-5-2-2">

<p>It is similar to the input struture except that is is used by the step function to publish its publications. To this effect, the step function has to fill the output structure.
</p></div>

</div>

<div id="outline-container-5-2-3" class="outline-4">
<h4 id="sec-5-2-3"><span class="section-number-4">5.2.3</span> The flag structures <code>radl_in_flags_t</code>, <code>radl_out_flags_t</code></h4>
<div class="outline-text-4" id="text-5-2-3">

<p>Similarly to the input and output structures, these have a field for each subscription (resp. publication). The type of each field is a <code>radl_flags_t</code> as described in <a href="../radl_lib/include/radl_flags.h">radl_flags.h</a>.
</p></div>
</div>

</div>

<div id="outline-container-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> C node definition</h3>
<div class="outline-text-3" id="text-5-3">

<p>Idem as the C++, except that instead of a class, the user needs to provide 4 things. To describe them, we use the default names provided by radl, but those may be decided in the radl file.
</p><ul>
<li>A state type, that we call <code>RADL_STATE</code> here
</li>
<li>An init function of signature : <code>void RADL_INIT_FUN(RADL_STATE *)</code>
</li>
<li>A step function of signature : <code>void RADL_STEP_FUN(RADL_STATE *, const radl_in_t*, const radl_inflags_t*, radl_out_t*, radl_outflags_t*)</code>
</li>
<li>A finish function of signature : <code>void RADL_FINISH_FUN(RADL_STATE *)</code>
</li>
</ul>

</div>

</div>

<div id="outline-container-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> The flags</h3>
<div class="outline-text-3" id="text-5-4">


</div>

<div id="outline-container-5-4-1" class="outline-4">
<h4 id="sec-5-4-1"><span class="section-number-4">5.4.1</span> Computation of the output flags</h4>
<div class="outline-text-4" id="text-5-4-1">

<p>The main idea of flags is to have some boolean metadata attached to messages, which by default propagate through nodes. To this effect, the default value of the output flags of each publication of a node are set to the logical OR of all the flags of its subscriptions, equivalent to the following pseudo code:
</p><pre class="example">
v = 0;
for each s in subscriptions:
    v = v OR in_flags-&gt;s
for each p in publications:
    out_flags-&gt;p = v
</pre>

<p>Then, the input flags are given to the step function as read-only while the pre set output flags are provided to the step function to give it a chance to turn on or off the desired flags. So, if the step function doesn't change the output flags, they will propagate the input flags.
</p></div>

</div>

<div id="outline-container-5-4-2" class="outline-4">
<h4 id="sec-5-4-2"><span class="section-number-4">5.4.2</span> Computation of the input flag <code>radl_STALE</code></h4>
<div class="outline-text-4" id="text-5-4-2">

<p>The so called stale flag has the broad meaning that its associated value isn't "fresh". More precisely, it either means that the publisher of the value flagged it as stale (by automatic propagation or by choice) or that no new message arrived since the last call to the step function. In the latter case, the step function gets the same input value (the mailbox hasn't changed) but it is flagged as stale.
To check if a subscription <code>s</code> is stale, one simply calls <code>radl_is_stale(in_flags-&gt;s)</code> which returns a boolean.
</p></div>

</div>

<div id="outline-container-5-4-3" class="outline-4">
<h4 id="sec-5-4-3"><span class="section-number-4">5.4.3</span> Computation of the input flag <code>radl_TIMEOUT</code></h4>
<div class="outline-text-4" id="text-5-4-3">

<p>The so called timeout flag has the broad meaning that its associated value has violated the timing constraints. More precisely, it either means that the publisher of the value flagged it as timeout (by automatic propgation or by choice) or that we haven't received a message since period of the publisher plus the maxlatency. In the latter case, timing constaints are exceeded and something unexpected is happening.
To check if a subscription <code>s</code> is timeout, one simply calls <code>radl_is_timeout(in_flags-&gt;s)</code> which returns a boolean.
</p></div>

</div>

<div id="outline-container-5-4-4" class="outline-4">
<h4 id="sec-5-4-4"><span class="section-number-4">5.4.4</span> Turning off/on output flags</h4>
<div class="outline-text-4" id="text-5-4-4">

<p>The function <code>radl_turn_on</code> is used to turn on a flag. For example to turn on the stale flag of the publication <code>p</code>, we would do:
</p><pre class="example">
radl_turn_on(rald_STALE, &amp;out_flags-&gt;p);
</pre>

<p>To turn off flags, the similar function <code>rald_turn_off</code> should be used.
</p></div>
</div>

</div>

<div id="outline-container-5-5" class="outline-3">
<h3 id="sec-5-5"><span class="section-number-3">5.5</span> Introspection</h3>
<div class="outline-text-3" id="text-5-5">

<p>To allow more robust and generic user code, it is possible to access values defined in the radl description.
</p>
</div>

<div id="outline-container-5-5-1" class="outline-4">
<h4 id="sec-5-5-1"><span class="section-number-4">5.5.1</span> Modules root entries</h4>
<div class="outline-text-4" id="text-5-5-1">

<p>The generic way of doing so is to use the generated module root ast access functions. For example if we want to read the radl value of qualname <code>module1.x</code>, one will first call the <code>radlast_module1</code> function to get to the module root entry.
</p></div>

</div>

<div id="outline-container-5-5-2" class="outline-4">
<h4 id="sec-5-5-2"><span class="section-number-4">5.5.2</span> Shortcuts</h4>
<div class="outline-text-4" id="text-5-5-2">

<p>Instead of needing to know the current module name and call the corresponding root ast access function, one can use the provided macro <code>RADL_MODULE</code>.
When writing a step function, one can directly access the node it is used in by using the <code>RADL_THIS</code> macro.
</p></div>

</div>

<div id="outline-container-5-5-3" class="outline-4">
<h4 id="sec-5-5-3"><span class="section-number-4">5.5.3</span> Field access</h4>
<div class="outline-text-4" id="text-5-5-3">

<p>The generic rule is that fields of values are the names of the declared value inside this value. This name is in turn
</p><ul>
<li>a pointer to the value (the generic case)
</li>
<li>the value itself (for a <code>topic</code>, a <code>struct</code> or inside them).
</li>
</ul>

</div>

</div>

<div id="outline-container-5-5-4" class="outline-4">
<h4 id="sec-5-5-4"><span class="section-number-4">5.5.4</span> The <code>DEFS</code> field</h4>
<div class="outline-text-4" id="text-5-5-4">

<p>To allow the user to define values which are not radl relevant, but that should be statically defined and shared, we added the <code>DEFS</code> field in the <code>node</code> and <code>topic</code> classes.
</p></div>

</div>

<div id="outline-container-5-5-5" class="outline-4">
<h4 id="sec-5-5-5"><span class="section-number-4">5.5.5</span> Example</h4>
<div class="outline-text-4" id="text-5-5-5">

<p>Let us consider we have the following radl description.
</p>


<pre class="example">---- file: introspec.radl ----
x : int32 1
t : topic { FIELDS
    a : int32 2
}
n : node {
    DEFS
        y : int32 3
        s : struct { FIELDS
            z : int32 4
        }
    PATH working_dir "nodes/example"
    CXX { PATH "src" FILENAME "n.cpp" }
}
----------------------------
</pre>

<p>
In the user code, if one desire to get the value of <code>x</code> (1), it has to do:
</p><pre class="example">
*(radlast_introspec()-&gt;x)
</pre>

<p>or
</p><pre class="example">
*(RADL_MODULE-&gt;x)
</pre>

<p>Note the indirection, since we are in the generic case, the field <code>x</code> is a pointer to its value.
To access <code>a</code>, since it is inside a <code>topic</code>, we don't need the indirection:
</p><pre class="example">
RADL_MODULE-&gt;t.a
</pre>

<p>Note that <code>t</code> is a topic so it is not a pointer, its field are accessed directly.
Same things apply for any other value, for example to read "nodes/example", one will do:
</p><pre class="example">
*(RADL_MODULE-&gt;n-&gt;working_dir)
</pre>

<p>or, when writing the step function for <code>n</code>:
</p><pre class="example">
*(RADL_THIS-&gt;working_dir)
</pre>

<p>Note that in order to access this value, we gave it a name in the radl description.
Finally, to sum it up all, to access <code>z</code> when writing the step function of <code>n</code>, one will do:
</p><pre class="example">
RADL_THIS-&gt;s.z
</pre>

</div>
</div>
</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2015-03-28T13:10-0700</p>
<p class="author">Author: Leonard Gerard</p>
<p class="creator"><a href="http://orgmode.org">Org</a> version 7.9.3f with <a href="http://www.gnu.org/software/emacs/">Emacs</a> version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
