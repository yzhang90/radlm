<?xml version="1.0"?>
<robot xmlns:sensor="http://playerstage.sourceforge.net/gazebo/xmlschema/#sensor"
       xmlns:controller="http://playerstage.sourceforge.net/gazebo/xmlschema/#controller"
       xmlns:interface="http://playerstage.sourceforge.net/gazebo/xmlschema/#interface"
       xmlns:xacro="http://ros.org/wiki/xacro">

  <property name="M_PI" value="3.1415926535897931" />
  
  <property name="footprint_z" value="0.5055" />
  <property name="footprint_x" value="0.1523" />

  <property name="base_mass" value="200.0" />
  <property name="base_cg_z" value="-0.4" />

  <property name="wheel_mass" value="0.5" />
  <property name="middle_wheel_x" value="0.06354" />
  <property name="front_wheel_x" value="0.3937" />
  <property name="rear_wheel_x" value="0.36826" />
  <property name="g_wheel_y" value="0.277774" />
  <property name="g_wheel_z" value="0.34684" />
  <property name="front_wheel_y" value="0.3032" />
  <property name="front_wheel_z" value="0.24524" />

  <property name="front_radar_x" value="0.568" />
  <property name="g_radar_z" value="0.0565" />
  <property name="rear_radar_x" value="-0.568" />

  <property name="front_camera_x" value="0.4983" />
  <property name="g_camera_z" value="0.137" />
  <property name="rear_camera_x" value="-0.4983" />

  <property name="g_gps_x" value="0.400" />
  <property name="g_gps_y" value="0.24915" />
  <property name="g_gps_z" value="0.038" />

  <property name="g_imu_x" value="-0.5115" />
  <property name="g_imu_y" value="0.0" />
  <property name="g_imu_z" value="0.1745" />

  <xacro:macro name="landshark_wheel" params="name parent orientation *origin">

    <joint name="${name}_wheel" type="continuous">
      <insert_block name="origin" />
      <parent link="${parent}"/>
      <child link="${name}_wheel_link"/>
      <axis xyz="0 1 0" />
      <limit effort="7" velocity="15"/>
      <safety_controller  k_velocity="10" />
      <dynamics damping="1.0" friction="0.0" />
    </joint>

    <link name="${name}_wheel_link">
      <inertial>
        <mass value="${wheel_mass}" />
        <origin xyz="0 0 0" />
        <inertia ixx="0.5" ixy="0" ixz="0"
                 iyy="0.5" iyz="0" izz="0.5" />
      </inertial>

      <visual>
        <origin xyz="0 0 0" rpy="0 0 ${orientation}" />
        <geometry>
          <mesh filename="package://landshark_description/meshes/landshark_wheel.STL" scale="0.001 0.001 0.001"/>
        </geometry>
        
        <material name="Black" />
      </visual>

      <collision>
        <origin xyz="0 0 0" rpy="0 0 ${orientation}" />
        <geometry>
          <mesh filename="package://landshark_description/meshes/landshark_wheel_collision.STL" scale="0.001 0.001 0.001"/>
        </geometry>
      </collision>
    </link>

  </xacro:macro>
  

  <xacro:macro name="landshark_base" params="name">

    <link name="${name}_footprint">
      <inertial>
        <mass value="0.1" />
        <origin xyz="0 0 0" />
        <inertia ixx="0.1" ixy="0" ixz="0"
                 iyy="0.1" iyz="0" izz="0.1" />
      </inertial>

      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <box size="0.01 0.01 0.01"/>
        </geometry>
        
        <material name="White" />
      </visual>

      <collision>
        <origin xyz="0 0 0.0" rpy="0 0 0" />
        <geometry>
          <box size="0.01 0.01 0.01"/>
        </geometry>
      </collision>
    </link>

    <joint name="${name}_footprint_joint" type="fixed">
      <origin xyz="${footprint_x} 0 ${footprint_z}" rpy="0 0 0" />
      <parent link="${name}_footprint"/>
      <child link="${name}_link" />
    </joint>

    <link name="${name}_link">
      <inertial>
        <mass value="${base_mass}" />
        <origin xyz="0 0 ${base_cg_z}" />
        <inertia ixx="1" ixy="0" ixz="0"
                 iyy="1" iyz="0" izz="1" />
      </inertial>

<!--      <visual>-->
<!--        <origin xyz="0 0 0" rpy="0 0 0" />-->
<!--        <geometry>-->
<!--          <mesh filename="package://landshark_description/meshes/landshark_base.STL" scale="0.001 0.001 0.001"/>-->
<!--        </geometry>-->
<!--        -->
<!--        <material name="Beige" />-->
<!--      </visual>-->

      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="package://landshark_description/meshes/landshark_base_collision.STL" scale="0.001 0.0008 0.001"/>
        </geometry>
      </collision>
    </link>

    <!-- Wheels -->
    <xacro:landshark_wheel name="middle_left" parent="${name}_link" orientation="0">
      <origin xyz="${middle_wheel_x} ${g_wheel_y} ${-g_wheel_z}" rpy="0 0 0" />
    </xacro:landshark_wheel>

    <xacro:landshark_wheel name="front_left" parent="${name}_link" orientation="0">
      <origin xyz="${front_wheel_x} ${front_wheel_y} ${-front_wheel_z}" rpy="0 0 0" />
    </xacro:landshark_wheel>

    <xacro:landshark_wheel name="rear_left" parent="${name}_link" orientation="0">
      <origin xyz="${-rear_wheel_x} ${g_wheel_y} ${-g_wheel_z}" rpy="0 0 0" />
    </xacro:landshark_wheel>

    <xacro:landshark_wheel name="middle_right" parent="${name}_link" orientation="${M_PI}">
      <origin xyz="${middle_wheel_x} ${-g_wheel_y} ${-g_wheel_z}" rpy="0 0 0" />
    </xacro:landshark_wheel>

    <xacro:landshark_wheel name="front_right" parent="${name}_link" orientation="${M_PI}">
      <origin xyz="${front_wheel_x} ${-front_wheel_y} ${-front_wheel_z}" rpy="0 0 0" />
    </xacro:landshark_wheel>

    <xacro:landshark_wheel name="rear_right" parent="${name}_link" orientation="${M_PI}">
      <origin xyz="${-rear_wheel_x} ${-g_wheel_y} ${-g_wheel_z}" rpy="0 0 0" />
    </xacro:landshark_wheel>

    <!-- Webots reference frame -->
    <joint name="${name}_webots_ref" type="fixed">
      <origin xyz="${middle_wheel_x} 0 ${-g_wheel_z}" rpy="0 0 0" />
      <parent link="${name}_link"/>
      <child link="${name}_webots_ref_link"/>
    </joint>

    <link name="${name}_webots_ref_link">
      <inertial>
        <mass value="0.001" />
        <origin xyz="0 0 0" />
        <inertia ixx="0.0005" ixy="0" ixz="0"
                 iyy="0.0005" iyz="0" izz="0.0005" />
      </inertial>
      
      <visual>
        <origin xyz="0 0 0" rpy="0 ${M_PI/2} 0" />
        <geometry>
          <cylinder length="0.001" radius="0.001"/>
        </geometry>
        
        <material name="Black" />
      </visual>

      <collision>
        <origin xyz="0 0 0" rpy="0 ${M_PI/2} 0" />
        <geometry>
          <cylinder length="0.001" radius="0.001"/>
        </geometry>
      </collision>
    </link>

    <!-- Radar -->
    <xacro:smartmicro_umpr31 name="front_radar" parent="${name}_link">
      <origin xyz="${front_radar_x} 0 ${g_radar_z}" rpy="0 0 0" />
    </xacro:smartmicro_umpr31>

    <xacro:smartmicro_umpr31 name="rear_radar" parent="${name}_link">
      <origin xyz="${rear_radar_x} 0 ${g_radar_z}" rpy="0 0 ${-M_PI}" />
    </xacro:smartmicro_umpr31>

    <!-- Camera -->
    <xacro:camera_ecl595 name="front_camera" parent="${name}_link">
      <origin xyz="${front_camera_x} 0 ${g_camera_z}" rpy="0 0 0" />
    </xacro:camera_ecl595>

    <xacro:camera_ecl595 name="rear_camera" parent="${name}_link">
      <origin xyz="${rear_camera_x} 0 ${g_camera_z}" rpy="0 0 ${-M_PI}" />
    </xacro:camera_ecl595>

    <!-- Gps -->
    <xacro:gps_garmin19x name="gps" parent="${name}_link">
      <origin xyz="${g_gps_x} ${g_gps_y} ${g_gps_z}" rpy="0 0 0" />
    </xacro:gps_garmin19x>

    <!-- Imu -->
    <xacro:imu_microstrain_3dmgx3 name="imu" parent="${name}_link">
      <origin xyz="${g_imu_x} ${g_imu_y} ${g_imu_z}" rpy="${M_PI} 0 0" />
    </xacro:imu_microstrain_3dmgx3>

  </xacro:macro>

</robot>
